<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#059669">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="images/icon-192x192.svg">
    <link rel="icon" type="image/svg+xml" href="images/icon-72x72.svg">
    <title>Rapor - PPG Sorong</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .rapor-container { max-width: 800px; margin: 0 auto; }
        .rapor-header { text-align: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid var(--gray-300); }
        .rapor-logo { font-size: 3rem; margin-bottom: 0.5rem; }
        .rapor-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 0.25rem; }
        .rapor-subtitle { color: var(--gray-600); }
        .rapor-info { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 2rem; }
        .rapor-info-item { display: flex; gap: 0.5rem; }
        .rapor-info-label { font-weight: 500; min-width: 120px; }
        .rapor-section { margin-bottom: 1.5rem; }
        .rapor-section-title { font-size: 1rem; font-weight: 600; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--gray-200); }
        .nilai-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
        .nilai-card { background: var(--gray-50); padding: 1rem; border-radius: var(--radius-md); text-align: center; }
        .nilai-card-label { font-size: 0.875rem; color: var(--gray-600); margin-bottom: 0.25rem; }
        .nilai-card-value { font-size: 1.5rem; font-weight: bold; }
        .nilai-alim { color: var(--primary); }
        .nilai-akhlak { color: var(--success); }
        .nilai-mandiri { color: var(--warning); }
        @media print {
            .no-print { display: none !important; }
            .card { box-shadow: none; border: 1px solid #ddd; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <aside class="sidebar no-print" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">PPG</div>
                <div><div class="sidebar-title">PPG Sorong</div><div class="sidebar-subtitle">Pembinaan Generasi Penerus</div></div>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">Menu Utama</div>
                <a href="dashboard.html" class="nav-item"><span class="nav-icon">üìä</span><span>Dashboard</span></a>
                <a href="jamaah.html" class="nav-item"><span class="nav-icon">üë•</span><span>Data Jamaah</span></a>
                <a href="pengajian.html" class="nav-item"><span class="nav-icon">üìñ</span><span>Pengajian</span></a>
                <a href="presensi.html" class="nav-item"><span class="nav-icon">‚úÖ</span><span>Presensi</span></a>
                <a href="progress.html" class="nav-item"><span class="nav-icon">üìà</span><span>Progress Hafalan</span></a>
                <div class="nav-section">Laporan</div>
                <a href="rapor.html" class="nav-item active"><span class="nav-icon">üìã</span><span>Rapor</span></a>
            </nav>
        </aside>
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
        
        <main class="main-content">
            <header class="header no-print">
                <div class="header-left"><h1 class="header-title">Rapor Santri</h1></div>
                <div class="header-right">
                    <div class="user-menu">
                        <div class="user-avatar" id="userAvatar">?</div>
                        <div class="user-info"><div class="user-name" id="userName">Loading...</div><div class="user-role" id="userRole">-</div></div>
                    </div>
                    <button class="btn btn-outline btn-sm" onclick="logout()">Keluar</button>
                </div>
            </header>
            
            <div class="page-content">
                <!-- Filter -->
                <div class="card mb-lg no-print">
                    <div class="card-body">
                        <div style="display:flex;flex-wrap:wrap;gap:1rem;align-items:flex-end;">
                            <div style="flex:1;min-width:200px;">
                                <label class="form-label">Santri</label>
                                <select class="form-control" id="selectSantri" onchange="loadRapor()">
                                    <option value="">-- Pilih Santri --</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">Tahun Ajaran</label>
                                <select class="form-control" id="selectTahunAjaran" onchange="loadRapor()">
                                    <option value="">-- Pilih --</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">Periode</label>
                                <select class="form-control" id="selectPeriode" onchange="loadRapor()">
                                    <option value="semester_1">Semester 1</option>
                                    <option value="semester_2">Semester 2</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Cetak</button>
                        </div>
                    </div>
                </div>
                
                <!-- Rapor Content -->
                <div class="card" id="raporCard" style="display:none;">
                    <div class="card-body">
                        <div class="rapor-container">
                            <div class="rapor-header">
                                <div class="rapor-logo">üìñ</div>
                                <div class="rapor-title">RAPOR SANTRI</div>
                                <div class="rapor-subtitle">Pembinaan Generasi Penerus (PPG) Sorong</div>
                            </div>
                            
                            <div class="rapor-info">
                                <div>
                                    <div class="rapor-info-item"><span class="rapor-info-label">Nama</span><span>: <span id="raporNama">-</span></span></div>
                                    <div class="rapor-info-item"><span class="rapor-info-label">Tempat, Tgl Lahir</span><span>: <span id="raporTTL">-</span></span></div>
                                    <div class="rapor-info-item"><span class="rapor-info-label">Jenis Kelamin</span><span>: <span id="raporJK">-</span></span></div>
                                </div>
                                <div>
                                    <div class="rapor-info-item"><span class="rapor-info-label">Jenjang</span><span>: <span id="raporJenjang">-</span></span></div>
                                    <div class="rapor-info-item"><span class="rapor-info-label">Kelompok</span><span>: <span id="raporKelompok">-</span></span></div>
                                    <div class="rapor-info-item"><span class="rapor-info-label">Tahun Ajaran</span><span>: <span id="raporTA">-</span></span></div>
                                </div>
                            </div>
                            
                            <div class="rapor-section">
                                <div class="rapor-section-title">üèÜ Nilai Tri Sukses</div>
                                <div class="nilai-grid">
                                    <div class="nilai-card">
                                        <div class="nilai-card-label">Alim Faqih</div>
                                        <div class="nilai-card-value nilai-alim" id="nilaiAlim">-</div>
                                    </div>
                                    <div class="nilai-card">
                                        <div class="nilai-card-label">Akhlaqul Karimah</div>
                                        <div class="nilai-card-value nilai-akhlak" id="nilaiAkhlak">-</div>
                                    </div>
                                    <div class="nilai-card">
                                        <div class="nilai-card-label">Mandiri</div>
                                        <div class="nilai-card-value nilai-mandiri" id="nilaiMandiri">-</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="rapor-section">
                                <div class="rapor-section-title">üìä Keaktifan</div>
                                <div style="display:flex;gap:2rem;flex-wrap:wrap;">
                                    <div><strong>Total Pengajian:</strong> <span id="totalPengajian">-</span></div>
                                    <div><strong>Hadir:</strong> <span id="totalHadir">-</span></div>
                                    <div><strong>Persentase:</strong> <span id="persenKeaktifan">-</span></div>
                                </div>
                                <div class="progress mt-md" style="height:12px;">
                                    <div class="progress-bar" id="progressBar" style="width:0%;"></div>
                                </div>
                            </div>
                            
                            <div class="rapor-section">
                                <div class="rapor-section-title">üìù Progress Hafalan</div>
                                <div class="table-container">
                                    <table class="table" id="progressTable">
                                        <thead>
                                            <tr>
                                                <th>Kategori</th>
                                                <th>Selesai</th>
                                                <th>Target</th>
                                                <th>Persentase</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="rapor-section">
                                <div class="rapor-section-title">üìå Catatan & Rekomendasi</div>
                                <div style="background:var(--gray-50);padding:1rem;border-radius:var(--radius-md);min-height:60px;" id="catatanRapor">
                                    -
                                </div>
                            </div>
                            
                            <div style="display:flex;justify-content:flex-end;margin-top:2rem;">
                                <div style="text-align:center;">
                                    <p>Sorong, <span id="tanggalRapor">-</span></p>
                                    <p style="margin-top:60px;border-top:1px solid var(--gray-400);padding-top:0.5rem;">Mubaligh</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card" id="emptyCard">
                    <div class="card-body">
                        <div class="empty-state">
                            <div class="empty-state-icon">üìã</div>
                            <div class="empty-state-title">Pilih Santri</div>
                            <p class="text-muted">Silakan pilih santri untuk melihat rapor</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/sidebar.js"></script>
    
    <script>
        
        function toggleSidebar() {
            $('sidebar').classList.toggle('collapsed');
            $('sidebarOverlay').classList.toggle('show');
        }

        document.addEventListener('DOMContentLoaded', async () => {
            if (!await requireAuth()) return;
            updateSidebarUserInfo();
            initSidebar();
            updateUserUI();
            await loadFilters();
        });
        
        function updateUserUI() {
            if (currentUserData) {
                $('userName').textContent = currentUserData.nama || currentUserData.email;
                $('userAvatar').textContent = (currentUserData.nama || 'U').charAt(0).toUpperCase();
                if (userRoles.length > 0) $('userRole').textContent = userRoles[0].role?.nama || '-';
            }
        }
        
        async function loadFilters() {
            try {
                // Load jamaah
                const { data: jamaah } = await db.from('jamaah').select('id, nama').eq('status_aktif', 'aktif').order('nama');
                const selectSantri = $('selectSantri');
                jamaah?.forEach(j => { selectSantri.innerHTML += `<option value="${j.id}">${j.nama}</option>`; });
                
                // Load tahun ajaran
                const { data: ta } = await db.from('tahun_ajaran').select('id, kode').order('kode', { ascending: false });
                const selectTA = $('selectTahunAjaran');
                ta?.forEach(t => { selectTA.innerHTML += `<option value="${t.id}">${t.kode}</option>`; });
                if (ta?.length > 0) selectTA.value = ta[0].id;
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        async function loadRapor() {
            const jamaahId = $('selectSantri').value;
            const tahunAjaranId = $('selectTahunAjaran').value;
            const periode = $('selectPeriode').value;
            
            if (!jamaahId) {
                $('raporCard').style.display = 'none';
                $('emptyCard').style.display = 'block';
                return;
            }
            
            try {
                // Get jamaah info
                const { data: jamaah } = await db.from('jamaah')
                    .select('*, enrollment(jenjang:jenjang_id(nama), wilayah:wilayah_id(nama))')
                    .eq('id', jamaahId)
                    .single();
                
                const enrollment = jamaah.enrollment?.[0];
                
                // Get tahun ajaran
                const { data: ta } = await db.from('tahun_ajaran').select('kode').eq('id', tahunAjaranId).single();
                
                // Fill rapor info
                $('raporNama').textContent = jamaah.nama;
                $('raporTTL').textContent = `${jamaah.tempat_lahir || '-'}, ${formatTanggal(jamaah.tanggal_lahir)}`;
                $('raporJK').textContent = jamaah.jenis_kelamin === 'L' ? 'Laki-laki' : 'Perempuan';
                $('raporJenjang').textContent = enrollment?.jenjang?.nama || '-';
                $('raporKelompok').textContent = enrollment?.wilayah?.nama || '-';
                $('raporTA').textContent = ta?.kode || '-';
                $('tanggalRapor').textContent = formatTanggal(new Date().toISOString());
                
                // Calculate nilai per bidang
                const { data: progress } = await db.from('progress_jamaah')
                    .select('*, materi_item:materi_item_id(kategori:kategori_id(bidang_id))')
                    .eq('jamaah_id', jamaahId)
                    .eq('status', 'selesai');
                
                let nilaiAlim = [], nilaiAkhlak = [], nilaiMandiri = [];
                progress?.forEach(p => {
                    if (p.nilai) {
                        const bidangId = p.materi_item?.kategori?.bidang_id;
                        if (bidangId === 1) nilaiAlim.push(p.nilai);
                        else if (bidangId === 2) nilaiAkhlak.push(p.nilai);
                        else if (bidangId === 3) nilaiMandiri.push(p.nilai);
                    }
                });
                
                const avg = arr => arr.length ? (arr.reduce((a,b) => a+b, 0) / arr.length).toFixed(1) : '-';
                $('nilaiAlim').textContent = avg(nilaiAlim);
                $('nilaiAkhlak').textContent = avg(nilaiAkhlak);
                $('nilaiMandiri').textContent = avg(nilaiMandiri);
                
                // Keaktifan (placeholder - would need date range filter)
                $('totalPengajian').textContent = '-';
                $('totalHadir').textContent = '-';
                $('persenKeaktifan').textContent = '-';
                $('progressBar').style.width = '0%';
                
                // Progress per kategori
                const { data: kategori } = await db.from('kategori_materi').select('id, nama').eq('is_aktif', true).order('urutan');
                
                let progressHtml = '';
                for (const k of (kategori || [])) {
                    const { count: selesai } = await db.from('progress_jamaah')
                        .select('*', { count: 'exact', head: true })
                        .eq('jamaah_id', jamaahId)
                        .eq('status', 'selesai')
                        .eq('materi_item.kategori_id', k.id);
                    
                    const { count: total } = await db.from('materi_item')
                        .select('*', { count: 'exact', head: true })
                        .eq('kategori_id', k.id);
                    
                    const persen = total > 0 ? ((selesai || 0) / total * 100).toFixed(0) : 0;
                    
                    progressHtml += `
                        <tr>
                            <td>${k.nama}</td>
                            <td>${selesai || 0}</td>
                            <td>${total || 0}</td>
                            <td>
                                <div style="display:flex;align-items:center;gap:0.5rem;">
                                    <div class="progress" style="flex:1;height:8px;">
                                        <div class="progress-bar ${persen >= 80 ? 'success' : persen >= 50 ? 'warning' : ''}" style="width:${persen}%;"></div>
                                    </div>
                                    <span>${persen}%</span>
                                </div>
                            </td>
                        </tr>
                    `;
                }
                $$('#progressTable tbody').innerHTML = progressHtml || '<tr><td colspan="4" class="text-center text-muted">Tidak ada data</td></tr>';
                
                $('catatanRapor').textContent = 'Terus tingkatkan hafalan dan keaktifan mengaji.';
                
                $('emptyCard').style.display = 'none';
                $('raporCard').style.display = 'block';
                
            } catch (error) {
                console.error('Error:', error);
                showToast('Gagal memuat rapor', 'error');
            }
        }
    </script>
</body>
</html>
