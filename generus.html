<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#059669">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="images/icon-192x192.svg">
    <link rel="icon" type="image/svg+xml" href="images/icon-72x72.svg">
    <title>Data Generus - PPG Sorong</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .tabs { display: flex; border-bottom: 2px solid var(--gray-200); margin-bottom: 1rem; overflow-x: auto; }
        .tab { padding: 0.5rem 1rem; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px; font-weight: 500; color: var(--gray-500); white-space: nowrap; font-size: 0.85rem; }
        .tab.active { border-bottom-color: var(--primary); color: var(--primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .info-box { background: #cffafe; border-left: 3px solid #06b6d4; border-radius: 0.25rem; padding: 0.5rem; margin-bottom: 1rem; font-size: 0.8rem; }
        .info-box.warning { background: #fef3c7; border-color: #f59e0b; }
        .current-info { background: #f8fafc; padding: 0.5rem; border-radius: 0.5rem; margin-bottom: 1rem; font-size: 0.85rem; }
        .current-info strong { color: #059669; }
        .search-select { position: relative; }
        .search-results { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #cbd5e1; border-radius: 0.5rem; max-height: 200px; overflow-y: auto; z-index: 10; display: none; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .search-results.show { display: block; }
        .search-result-item { padding: 0.5rem; cursor: pointer; border-bottom: 1px solid #f1f5f9; font-size: 0.85rem; }
        .search-result-item:hover { background: #d1fae5; }
        .selected-person { background: #dcfce7; padding: 0.5rem; border-radius: 0.5rem; display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; }
        .selected-person .remove { cursor: pointer; color: #ef4444; font-size: 1.1rem; }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">PPG</div>
                <div class="sidebar-brand">
                    <div class="sidebar-title">PPG Sorong</div>
                    <div class="sidebar-subtitle">Pembinaan Generasi Penerus</div>
                </div>
                <button class="sidebar-close" onclick="toggleSidebar()">‚úï</button>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">MENU UTAMA</div>
                <a href="dashboard.html" class="nav-item"><span class="nav-icon">üìä</span><span class="nav-text">Dashboard</span></a>
                <a href="generus.html" class="nav-item active"><span class="nav-icon">üë∂</span><span class="nav-text">Data Generus</span></a>
                <a href="pengajian.html" class="nav-item"><span class="nav-icon">üìñ</span><span class="nav-text">Pengajian</span></a>
                <a href="presensi.html" class="nav-item"><span class="nav-icon">‚úÖ</span><span class="nav-text">Presensi</span></a>
                <a href="progress.html" class="nav-item"><span class="nav-icon">üìà</span><span class="nav-text">Progress Hafalan</span></a>
                <div class="nav-section">LAPORAN</div>
                <a href="rapor.html" class="nav-item"><span class="nav-icon">üìã</span><span class="nav-text">Rapor</span></a>
                <div class="nav-section">PENGATURAN</div>
                <a href="wilayah.html" class="nav-item"><span class="nav-icon">üó∫Ô∏è</span><span class="nav-text">Wilayah</span></a>
                <a href="kurikulum.html" class="nav-item"><span class="nav-icon">üìö</span><span class="nav-text">Kurikulum</span></a>
                <a href="jamaah.html" class="nav-item"><span class="nav-icon">üë•</span><span class="nav-text">Data Jamaah</span></a>
                <a href="users.html" class="nav-item"><span class="nav-icon">üë§</span><span class="nav-text">Manajemen User</span></a>
            </nav>
            <div class="sidebar-footer">
                <div class="sidebar-user">
                    <div class="sidebar-user-avatar" id="sidebarUserAvatar">?</div>
                    <div class="sidebar-user-info">
                        <div class="sidebar-user-name" id="sidebarUserName">Loading...</div>
                        <div class="sidebar-user-role" id="sidebarUserRole">-</div>
                    </div>
                </div>
                <button class="btn btn-sm btn-outline w-100" onclick="logout()">üö™ Keluar</button>
            </div>
        </aside>
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
        
        <!-- Main Content -->
        <main class="main-content">
            <header class="header">
                <div class="header-left">
                    <button class="btn-menu" onclick="toggleSidebar()"><span class="menu-icon">‚ò∞</span></button>
                    <h1 class="header-title">Data Generus</h1>
                </div>
                <div class="header-right">
                    <div class="header-user">
                        <div class="user-avatar" id="userAvatar">?</div>
                        <div class="user-info">
                            <div class="user-name" id="userName">Loading...</div>
                            <div class="user-role" id="userRole">-</div>
                        </div>
                    </div>
                    <button class="btn-logout-mobile" onclick="logout()">üö™</button>
                </div>
            </header>
            
            <div class="page-content">
                <div class="page-header">
                    <h2 class="page-title">Daftar Generus</h2>
                    <p class="text-muted text-xs">Jamaah yang belum menikah</p>
                </div>
                
                <!-- Filters -->
                <div class="card mb-sm">
                    <div class="card-body">
                        <div class="filter-grid">
                            <select class="form-control" id="filterDaerah" onchange="onDaerahChange()">
                                <option value="">Semua Daerah</option>
                            </select>
                            <select class="form-control" id="filterKelompok" onchange="loadGenerus()">
                                <option value="">Semua Kelompok</option>
                            </select>
                        </div>
                        <div style="margin-top:8px;">
                            <input type="text" class="form-control" id="searchInput" placeholder="üîç Cari nama..." oninput="debounceSearch()">
                        </div>
                    </div>
                </div>
                
                <!-- Data Table -->
                <div class="card">
                    <div class="card-header">
                        <span id="infoTotal">Total: -</span>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table" id="generusTable">
                                <thead>
                                    <tr>
                                        <th width="35">NO</th>
                                        <th>NAMA</th>
                                        <th width="45">L/P</th>
                                        <th width="45">UMUR</th>
                                        <th width="70">JENJANG</th>
                                        <th>KELOMPOK</th>
                                        <th width="50" id="colAksi" style="display:none;">AKSI</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="7" class="text-center text-muted py-4">Memuat...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Modal Edit Generus -->
            <div class="modal" id="editModal">
                <div class="modal-content" style="max-height:92vh;">
                    <div class="modal-header">
                        <h3 class="modal-title">üìù Edit Generus</h3>
                        <button class="modal-close" onclick="closeEditModal()">&times;</button>
                    </div>
                    <div class="modal-body" style="overflow-y:auto;">
                        <!-- Tabs -->
                        <div class="tabs">
                            <div class="tab active" onclick="switchTab('tabData', this)">üìã Data</div>
                            <div class="tab" onclick="switchTab('tabKelompok', this)">üè† Pindah</div>
                            <div class="tab" onclick="switchTab('tabStatus', this)">üíç Status</div>
                        </div>
                        
                        <input type="hidden" id="editId">
                        <input type="hidden" id="editEnrollmentId">
                        <input type="hidden" id="editCurrentKelompokId">
                        
                        <!-- Tab 1: Data Diri -->
                        <div class="tab-content active" id="tabData">
                            <div class="form-group">
                                <label class="form-label">Nama Lengkap *</label>
                                <input type="text" class="form-control" id="editNama" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Nama Panggilan</label>
                                <input type="text" class="form-control" id="editNamaPanggilan">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Jenis Kelamin *</label>
                                    <select class="form-control" id="editJenisKelamin" required>
                                        <option value="">Pilih</option>
                                        <option value="L">Laki-laki</option>
                                        <option value="P">Perempuan</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Tanggal Lahir</label>
                                    <input type="date" class="form-control" id="editTanggalLahir" onchange="showUmur()">
                                    <small class="form-text" id="editUmurInfo"></small>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">No. HP</label>
                                <input type="text" class="form-control" id="editPhone">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Alamat</label>
                                <textarea class="form-control" id="editAlamat" rows="2"></textarea>
                            </div>
                            <button type="button" class="btn btn-primary w-100" onclick="saveDataDiri()">üíæ Simpan Data</button>
                        </div>
                        
                        <!-- Tab 2: Pindah Kelompok -->
                        <div class="tab-content" id="tabKelompok">
                            <div class="current-info">
                                <strong>Kelompok:</strong> <span id="currentKelompokName">-</span><br>
                                <strong>Jenjang:</strong> <span id="currentJenjangName">-</span>
                            </div>
                            
                            <div class="info-box">
                                ‚ÑπÔ∏è Pindah kelompok akan menutup enrollment lama dan membuat baru.
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Daerah Tujuan</label>
                                <select class="form-control" id="pindahDaerah" onchange="loadKelompokTujuan()">
                                    <option value="">Pilih Daerah</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Kelompok Tujuan *</label>
                                <select class="form-control" id="pindahKelompok">
                                    <option value="">Pilih Kelompok</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tanggal Pindah</label>
                                <input type="date" class="form-control" id="pindahTanggal">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Keterangan</label>
                                <textarea class="form-control" id="pindahKeterangan" rows="2" placeholder="Alasan pindah..."></textarea>
                            </div>
                            <button type="button" class="btn btn-primary w-100" onclick="savePindahKelompok()">üè† Pindah Kelompok</button>
                        </div>
                        
                        <!-- Tab 3: Status -->
                        <div class="tab-content" id="tabStatus">
                            <div class="current-info">
                                <strong>Status:</strong> <span id="currentStatus">-</span>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Ubah Status</label>
                                <select class="form-control" id="newStatus" onchange="onStatusChange()">
                                    <option value="">-- Pilih --</option>
                                    <option value="aktif">‚úÖ Aktif</option>
                                    <option value="menikah">üíç Menikah</option>
                                    <option value="nonaktif">‚è∏Ô∏è Nonaktif</option>
                                    <option value="pindah">üöö Pindah (Keluar PPG)</option>
                                    <option value="meninggal">üïØÔ∏è Meninggal</option>
                                </select>
                            </div>
                            
                            <!-- Form Menikah -->
                            <div id="formMenikah" style="display:none;">
                                <div class="info-box warning">
                                    üíç Setelah menikah, akan pindah ke jenjang <strong>Dewasa</strong>.
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Tanggal Menikah *</label>
                                    <input type="date" class="form-control" id="tanggalMenikah">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Pasangan dari Jamaah PPG?</label>
                                    <select class="form-control" id="pasanganDariPPG" onchange="togglePasanganForm()">
                                        <option value="ya">Ya, pilih dari jamaah</option>
                                        <option value="tidak">Tidak</option>
                                    </select>
                                </div>
                                
                                <!-- Pilih Pasangan dari Jamaah -->
                                <div id="formPasanganPPG">
                                    <div class="form-group">
                                        <label class="form-label">Cari Pasangan</label>
                                        <div class="search-select">
                                            <input type="text" class="form-control" id="searchPasangan" placeholder="Ketik nama..." oninput="searchPasanganJamaah()">
                                            <div class="search-results" id="searchPasanganResults"></div>
                                        </div>
                                        <div id="selectedPasangan" style="margin-top:8px;"></div>
                                        <input type="hidden" id="pasanganJamaahId">
                                    </div>
                                </div>
                                
                                <!-- Input Manual Pasangan -->
                                <div id="formPasanganManual" style="display:none;">
                                    <div class="form-group">
                                        <label class="form-label">Nama Pasangan</label>
                                        <input type="text" class="form-control" id="pasanganNama" placeholder="Nama pasangan">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Form Nonaktif/Pindah/Meninggal -->
                            <div id="formNonaktif" style="display:none;">
                                <div class="form-group">
                                    <label class="form-label">Tanggal</label>
                                    <input type="date" class="form-control" id="tanggalNonaktif">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Keterangan</label>
                                    <textarea class="form-control" id="keteranganNonaktif" rows="2"></textarea>
                                </div>
                            </div>
                            
                            <button type="button" class="btn btn-primary w-100" onclick="saveStatus()">üíæ Simpan Status</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/sidebar.js"></script>
    
    <script>
        let allKelompok = [];
        let currentEditData = null;
        const JENJANG_DEWASA_ID = 23;
        
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }
        
        const debounceSearch = debounce(() => loadGenerus(), 300);
        
        function $(id) { return document.getElementById(id); }
        function $$(sel) { return document.querySelector(sel); }
        
        function toggleSidebar() {
            $('sidebar').classList.toggle('show');
            $('sidebarOverlay').classList.toggle('show');
        }

        document.addEventListener('DOMContentLoaded', async () => {
            if (!await requireAuth()) return;
            updateSidebarUserInfo();
            updateUserUI();
            
            const today = new Date().toISOString().split('T')[0];
            $('pindahTanggal').value = today;
            $('tanggalMenikah').value = today;
            $('tanggalNonaktif').value = today;
            
            await loadFilters();
            await loadGenerus();
        });
        
        function updateUserUI() {
            if (currentUserData) {
                $('userName').textContent = currentUserData.nama || currentUserData.email;
                $('userAvatar').textContent = (currentUserData.nama || 'U').charAt(0).toUpperCase();
                if (userRoles && userRoles.length > 0) {
                    $('userRole').textContent = userRoles[0].role?.nama || '-';
                }
            }
        }
        
        async function loadFilters() {
            try {
                const { data: daerahList } = await db.from('wilayah')
                    .select('id, nama').eq('tingkat', 'daerah').eq('is_aktif', true).order('nama');
                
                if (daerahList) {
                    $('filterDaerah').innerHTML = '<option value="">Semua Daerah</option>' +
                        daerahList.map(d => '<option value="' + d.id + '">' + d.nama + '</option>').join('');
                    $('pindahDaerah').innerHTML = '<option value="">Pilih Daerah</option>' +
                        daerahList.map(d => '<option value="' + d.id + '">' + d.nama + '</option>').join('');
                }
                
                const { data: kelompokList } = await db.from('wilayah')
                    .select('id, nama, parent_id').eq('tingkat', 'kelompok').eq('is_aktif', true).order('nama');
                
                if (kelompokList) {
                    allKelompok = kelompokList;
                    $('filterKelompok').innerHTML = '<option value="">Semua Kelompok</option>' +
                        kelompokList.map(k => '<option value="' + k.id + '">' + k.nama + '</option>').join('');
                }
            } catch (error) {
                console.error('Error loading filters:', error);
            }
        }
        
        async function onDaerahChange() {
            const daerahId = $('filterDaerah').value;
            if (daerahId) {
                const { data: desaList } = await db.from('wilayah')
                    .select('id').eq('parent_id', daerahId).eq('tingkat', 'desa');
                
                if (desaList && desaList.length > 0) {
                    const desaIds = desaList.map(d => d.id);
                    const filtered = allKelompok.filter(k => desaIds.includes(k.parent_id));
                    $('filterKelompok').innerHTML = '<option value="">Semua Kelompok</option>' +
                        filtered.map(k => '<option value="' + k.id + '">' + k.nama + '</option>').join('');
                }
            } else {
                $('filterKelompok').innerHTML = '<option value="">Semua Kelompok</option>' +
                    allKelompok.map(k => '<option value="' + k.id + '">' + k.nama + '</option>').join('');
            }
            loadGenerus();
        }
        
        async function loadKelompokTujuan() {
            const daerahId = $('pindahDaerah').value;
            if (!daerahId) {
                $('pindahKelompok').innerHTML = '<option value="">Pilih Kelompok</option>';
                return;
            }
            
            const { data: desaList } = await db.from('wilayah')
                .select('id').eq('parent_id', daerahId).eq('tingkat', 'desa');
            
            if (desaList && desaList.length > 0) {
                const desaIds = desaList.map(d => d.id);
                const filtered = allKelompok.filter(k => desaIds.includes(k.parent_id));
                $('pindahKelompok').innerHTML = '<option value="">Pilih Kelompok</option>' +
                    filtered.map(k => '<option value="' + k.id + '">' + k.nama + '</option>').join('');
            }
        }
        
        async function loadGenerus() {
            try {
                const kelompokId = $('filterKelompok').value;
                const search = $('searchInput').value.toLowerCase();
                
                const { data, error } = await db.rpc('get_generus_by_wilayah', {
                    p_wilayah_id: kelompokId ? parseInt(kelompokId) : null,
                    p_jenjang_id: null,
                    p_status: 'aktif'
                });
                
                if (error) throw error;
                
                let filtered = data || [];
                if (search) {
                    filtered = filtered.filter(function(g) {
                        return g.nama.toLowerCase().includes(search) ||
                            (g.nama_panggilan && g.nama_panggilan.toLowerCase().includes(search));
                    });
                }
                
                $('infoTotal').textContent = 'Total: ' + filtered.length;
                renderTable(filtered);
                
            } catch (error) {
                console.error('Error:', error);
                showToast('Gagal memuat data: ' + error.message, 'error');
            }
        }
        
        function renderTable(data) {
            var tbody = $$('#generusTable tbody');
            if (!data.length) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">Tidak ada data</td></tr>';
                return;
            }
            
            var canEdit = userRoles && userRoles.some(function(r) {
                var kode = r.role && r.role.kode ? r.role.kode.toLowerCase() : '';
                return ['admin', 'mubaligh', 'mubaligh_daerah', 'mubaligh_desa', 'imam_kelompok'].includes(kode);
            });
            
            $('colAksi').style.display = canEdit ? '' : 'none';
            
            var html = '';
            for (var i = 0; i < data.length; i++) {
                var g = data[i];
                html += '<tr>';
                html += '<td>' + (i + 1) + '</td>';
                html += '<td><strong>' + g.nama + '</strong>';
                if (g.nama_panggilan) html += '<br><small class="text-muted">' + g.nama_panggilan + '</small>';
                html += '</td>';
                html += '<td>' + (g.jenis_kelamin || '-') + '</td>';
                html += '<td>' + (g.tanggal_lahir ? hitungUmur(g.tanggal_lahir) : '-') + '</td>';
                html += '<td><span class="badge badge-info">' + (g.jenjang_nama || '-') + '</span></td>';
                html += '<td>' + (g.kelompok_nama || '-') + '</td>';
                if (canEdit) {
                    html += '<td><button class="btn btn-sm btn-outline" onclick="editGenerus(' + g.jamaah_id + ')">‚úèÔ∏è</button></td>';
                }
                html += '</tr>';
            }
            tbody.innerHTML = html;
        }
        
        // ========== EDIT ==========
        async function editGenerus(id) {
            try {
                var result = await db.from('jamaah').select('*').eq('id', id).single();
                if (result.error) throw result.error;
                var jamaah = result.data;
                
                var enrollResult = await db.from('enrollment')
                    .select('*, jenjang:jenjang_id(id, nama), wilayah:wilayah_id(id, nama)')
                    .eq('jamaah_id', id).eq('status', 'aktif').single();
                var enrollment = enrollResult.data;
                
                currentEditData = { jamaah: jamaah, enrollment: enrollment };
                
                // Tab 1
                $('editId').value = jamaah.id;
                $('editNama').value = jamaah.nama || '';
                $('editNamaPanggilan').value = jamaah.nama_panggilan || '';
                $('editJenisKelamin').value = jamaah.jenis_kelamin || '';
                $('editTanggalLahir').value = jamaah.tanggal_lahir || '';
                $('editPhone').value = jamaah.phone || '';
                $('editAlamat').value = jamaah.alamat_lengkap || '';
                showUmur();
                
                // Tab 2
                $('editEnrollmentId').value = enrollment ? enrollment.id : '';
                $('editCurrentKelompokId').value = enrollment ? enrollment.wilayah_id : '';
                $('currentKelompokName').textContent = enrollment && enrollment.wilayah ? enrollment.wilayah.nama : 'Belum terdaftar';
                $('currentJenjangName').textContent = enrollment && enrollment.jenjang ? enrollment.jenjang.nama : '-';
                
                // Tab 3
                $('currentStatus').textContent = jamaah.status_aktif || 'aktif';
                $('newStatus').value = '';
                $('formMenikah').style.display = 'none';
                $('formNonaktif').style.display = 'none';
                $('pasanganJamaahId').value = '';
                $('selectedPasangan').innerHTML = '';
                $('searchPasangan').value = '';
                
                switchTab('tabData', document.querySelector('.tab'));
                $('editModal').classList.add('show');
                
            } catch (error) {
                showToast('Gagal memuat: ' + error.message, 'error');
            }
        }
        
        function closeEditModal() {
            $('editModal').classList.remove('show');
            currentEditData = null;
        }
        
        function switchTab(tabId, el) {
            var tabs = document.querySelectorAll('.tab');
            for (var i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            if (el) el.classList.add('active');
            
            var contents = document.querySelectorAll('.tab-content');
            for (var i = 0; i < contents.length; i++) {
                contents[i].classList.remove('active');
            }
            $(tabId).classList.add('active');
        }
        
        function showUmur() {
            var tgl = $('editTanggalLahir').value;
            $('editUmurInfo').innerHTML = tgl ? '<strong>Umur: ' + hitungUmur(tgl) + ' tahun</strong>' : '';
        }
        
        // ========== SAVE DATA ==========
        async function saveDataDiri() {
            var id = $('editId').value;
            try {
                var result = await db.from('jamaah').update({
                    nama: $('editNama').value,
                    nama_panggilan: $('editNamaPanggilan').value || null,
                    jenis_kelamin: $('editJenisKelamin').value,
                    tanggal_lahir: $('editTanggalLahir').value || null,
                    phone: $('editPhone').value || null,
                    alamat_lengkap: $('editAlamat').value || null
                }).eq('id', id);
                
                if (result.error) throw result.error;
                showToast('Data berhasil disimpan!', 'success');
                closeEditModal();
                loadGenerus();
            } catch (error) {
                showToast('Gagal: ' + error.message, 'error');
            }
        }
        
        // ========== PINDAH KELOMPOK ==========
        async function savePindahKelompok() {
            var jamaahId = $('editId').value;
            var enrollmentId = $('editEnrollmentId').value;
            var kelompokBaru = $('pindahKelompok').value;
            var tanggal = $('pindahTanggal').value;
            var keterangan = $('pindahKeterangan').value;
            
            if (!kelompokBaru) {
                showToast('Pilih kelompok tujuan!', 'error');
                return;
            }
            if (kelompokBaru == $('editCurrentKelompokId').value) {
                showToast('Kelompok sama!', 'error');
                return;
            }
            
            try {
                if (enrollmentId) {
                    await db.from('enrollment').update({ 
                        status: 'pindah', 
                        tanggal_selesai: tanggal, 
                        keterangan: keterangan || 'Pindah kelompok'
                    }).eq('id', enrollmentId);
                }
                
                var taResult = await db.from('tahun_ajaran').select('id').eq('is_aktif', true).single();
                var taId = taResult.data ? taResult.data.id : 1;
                
                var jenjangId = currentEditData && currentEditData.enrollment ? currentEditData.enrollment.jenjang_id : null;
                
                var result = await db.from('enrollment').insert({
                    jamaah_id: parseInt(jamaahId),
                    wilayah_id: parseInt(kelompokBaru),
                    jenjang_id: jenjangId,
                    tahun_ajaran_id: taId,
                    tanggal_mulai: tanggal,
                    status: 'aktif',
                    keterangan: 'Pindah dari kelompok lain'
                });
                
                if (result.error) throw result.error;
                showToast('Berhasil pindah kelompok!', 'success');
                closeEditModal();
                loadGenerus();
            } catch (error) {
                showToast('Gagal: ' + error.message, 'error');
            }
        }
        
        // ========== STATUS ==========
        function onStatusChange() {
            var status = $('newStatus').value;
            $('formMenikah').style.display = status === 'menikah' ? 'block' : 'none';
            $('formNonaktif').style.display = ['nonaktif', 'pindah', 'meninggal'].includes(status) ? 'block' : 'none';
        }
        
        function togglePasanganForm() {
            var val = $('pasanganDariPPG').value;
            $('formPasanganPPG').style.display = val === 'ya' ? 'block' : 'none';
            $('formPasanganManual').style.display = val === 'tidak' ? 'block' : 'none';
        }
        
        async function searchPasanganJamaah() {
            var search = $('searchPasangan').value.toLowerCase();
            var resultsDiv = $('searchPasanganResults');
            
            if (search.length < 2) { 
                resultsDiv.classList.remove('show'); 
                return; 
            }
            
            var currentGender = currentEditData && currentEditData.jamaah ? currentEditData.jamaah.jenis_kelamin : 'L';
            var searchGender = currentGender === 'L' ? 'P' : 'L';
            var currentId = currentEditData && currentEditData.jamaah ? currentEditData.jamaah.id : 0;
            
            var result = await db.from('jamaah')
                .select('id, nama, nama_panggilan, tanggal_lahir')
                .neq('id', currentId)
                .eq('jenis_kelamin', searchGender)
                .ilike('nama', '%' + search + '%')
                .limit(10);
            
            var data = result.data;
            
            if (data && data.length > 0) {
                var html = '';
                for (var i = 0; i < data.length; i++) {
                    var j = data[i];
                    var umurText = j.tanggal_lahir ? ' - ' + hitungUmur(j.tanggal_lahir) + ' th' : '';
                    html += '<div class="search-result-item" onclick="selectPasangan(' + j.id + ', \'' + j.nama.replace(/'/g, "\\'") + '\', \'' + (j.tanggal_lahir || '') + '\')">';
                    html += '<strong>' + j.nama + '</strong>' + umurText;
                    html += '</div>';
                }
                resultsDiv.innerHTML = html;
            } else {
                resultsDiv.innerHTML = '<div class="search-result-item text-muted">Tidak ditemukan</div>';
            }
            resultsDiv.classList.add('show');
        }
        
        function selectPasangan(id, nama, tgl) {
            $('pasanganJamaahId').value = id;
            $('searchPasangan').value = '';
            $('searchPasanganResults').classList.remove('show');
            var umurText = tgl ? ' (' + hitungUmur(tgl) + ' th)' : '';
            $('selectedPasangan').innerHTML = '<div class="selected-person"><span>üíç ' + nama + umurText + '</span><span class="remove" onclick="removePasangan()">‚úï</span></div>';
        }
        
        function removePasangan() {
            $('pasanganJamaahId').value = '';
            $('selectedPasangan').innerHTML = '';
        }
        
        async function saveStatus() {
            var status = $('newStatus').value;
            if (!status) {
                showToast('Pilih status!', 'error');
                return;
            }
            
            var jamaahId = parseInt($('editId').value);
            
            try {
                if (status === 'menikah') {
                    await prosesMenuikah(jamaahId);
                } else if (['nonaktif', 'pindah', 'meninggal'].includes(status)) {
                    await prosesNonaktif(jamaahId, status);
                } else if (status === 'aktif') {
                    await db.from('jamaah').update({ status_aktif: 'aktif' }).eq('id', jamaahId);
                    showToast('Status: Aktif', 'success');
                }
                closeEditModal();
                loadGenerus();
            } catch (error) {
                showToast('Gagal: ' + error.message, 'error');
            }
        }
        
        async function prosesMenuikah(jamaahId) {
            var tanggal = $('tanggalMenikah').value;
            var pasanganId = $('pasanganJamaahId').value;
            
            if (!tanggal) {
                showToast('Isi tanggal menikah!', 'error');
                return;
            }
            
            var enrollmentId = $('editEnrollmentId').value;
            if (enrollmentId) {
                await db.from('enrollment').update({ jenjang_id: JENJANG_DEWASA_ID }).eq('id', enrollmentId);
            }
            
            if ($('pasanganDariPPG').value === 'ya' && pasanganId) {
                var gender = currentEditData && currentEditData.jamaah ? currentEditData.jamaah.jenis_kelamin : 'L';
                
                await db.from('relasi_keluarga').insert([
                    { jamaah_id: jamaahId, relasi_dengan_jamaah_id: parseInt(pasanganId), tipe_relasi: gender === 'L' ? 'suami' : 'istri', status_relasi: 'aktif', tanggal_mulai: tanggal },
                    { jamaah_id: parseInt(pasanganId), relasi_dengan_jamaah_id: jamaahId, tipe_relasi: gender === 'L' ? 'istri' : 'suami', status_relasi: 'aktif', tanggal_mulai: tanggal }
                ]);
                
                var pEnrollResult = await db.from('enrollment').select('id').eq('jamaah_id', pasanganId).eq('status', 'aktif').single();
                if (pEnrollResult.data) {
                    await db.from('enrollment').update({ jenjang_id: JENJANG_DEWASA_ID }).eq('id', pEnrollResult.data.id);
                }
            }
            
            showToast('Status menikah disimpan!', 'success');
        }
        
        async function prosesNonaktif(jamaahId, status) {
            var tanggal = $('tanggalNonaktif').value;
            var keterangan = $('keteranganNonaktif').value;
            
            await db.from('jamaah').update({ 
                status_aktif: status, 
                tanggal_nonaktif: tanggal || null, 
                keterangan: keterangan || null
            }).eq('id', jamaahId);
            
            var enrollmentId = $('editEnrollmentId').value;
            if (enrollmentId) {
                await db.from('enrollment').update({ 
                    status: status === 'meninggal' ? 'nonaktif' : status, 
                    tanggal_selesai: tanggal
                }).eq('id', enrollmentId);
            }
            
            if (status === 'meninggal') {
                await db.from('relasi_keluarga').update({ status_relasi: 'meninggal' })
                    .or('jamaah_id.eq.' + jamaahId + ',relasi_dengan_jamaah_id.eq.' + jamaahId);
            }
            
            showToast('Status: ' + status, 'success');
        }
        
        function hitungUmur(tgl) {
            var today = new Date();
            var birth = new Date(tgl);
            var age = today.getFullYear() - birth.getFullYear();
            if (today.getMonth() < birth.getMonth() || (today.getMonth() === birth.getMonth() && today.getDate() < birth.getDate())) {
                age--;
            }
            return age;
        }
        
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-select')) {
                $('searchPasanganResults').classList.remove('show');
            }
        });
    </script>
    
    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="dashboard.html" class="bottom-nav-item"><span class="bottom-nav-icon">üìä</span><span class="bottom-nav-label">Home</span></a>
        <a href="generus.html" class="bottom-nav-item active"><span class="bottom-nav-icon">üë∂</span><span class="bottom-nav-label">Generus</span></a>
        <a href="presensi.html" class="bottom-nav-item"><span class="bottom-nav-icon">‚úÖ</span><span class="bottom-nav-label">Presensi</span></a>
        <a href="progress.html" class="bottom-nav-item"><span class="bottom-nav-icon">üìà</span><span class="bottom-nav-label">Progress</span></a>
        <a href="#" class="bottom-nav-item" onclick="toggleSidebar(); return false;"><span class="bottom-nav-icon">‚ò∞</span><span class="bottom-nav-label">Menu</span></a>
    </nav>
</body>
</html>
