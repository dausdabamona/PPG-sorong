<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#059669">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="images/icon-192x192.svg">
    <link rel="icon" type="image/svg+xml" href="images/icon-72x72.svg">
    <title>Data Jamaah - PPG Sorong</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">PPG</div>
                <div class="sidebar-brand">
                    <div class="sidebar-title">PPG Sorong</div>
                    <div class="sidebar-subtitle">Pembinaan Generasi Penerus</div>
                </div>
                <button class="sidebar-close" onclick="toggleSidebar()">‚úï</button>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">MENU UTAMA</div>
                <a href="dashboard.html" class="nav-item"><span class="nav-icon">üìä</span><span class="nav-text">Dashboard</span></a>
                <a href="generus.html" class="nav-item"><span class="nav-icon">üë∂</span><span class="nav-text">Data Generus</span></a>
                <a href="pengajian.html" class="nav-item"><span class="nav-icon">üìñ</span><span class="nav-text">Pengajian</span></a>
                <a href="presensi.html" class="nav-item"><span class="nav-icon">‚úÖ</span><span class="nav-text">Presensi</span></a>
                <a href="progress.html" class="nav-item"><span class="nav-icon">üìà</span><span class="nav-text">Progress Hafalan</span></a>
                <div class="nav-section">LAPORAN</div>
                <a href="rapor.html" class="nav-item"><span class="nav-icon">üìã</span><span class="nav-text">Rapor</span></a>
                <div class="nav-section">PENGATURAN</div>
                <a href="wilayah.html" class="nav-item"><span class="nav-icon">üó∫Ô∏è</span><span class="nav-text">Wilayah</span></a>
                <a href="kurikulum.html" class="nav-item"><span class="nav-icon">üìö</span><span class="nav-text">Kurikulum</span></a>
                <a href="jamaah.html" class="nav-item active"><span class="nav-icon">üë•</span><span class="nav-text">Data Jamaah</span></a>
                <a href="users.html" class="nav-item"><span class="nav-icon">üë§</span><span class="nav-text">Manajemen User</span></a>
            </nav>
            <div class="sidebar-footer">
                <div class="sidebar-user">
                    <div class="sidebar-user-avatar" id="sidebarUserAvatar">?</div>
                    <div class="sidebar-user-info">
                        <div class="sidebar-user-name" id="sidebarUserName">Loading...</div>
                        <div class="sidebar-user-role" id="sidebarUserRole">-</div>
                    </div>
                </div>
                <button class="btn btn-sm btn-outline w-100" onclick="logout()">üö™ Keluar</button>
            </div>
        </aside>
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
        
        <!-- Main Content -->
        <main class="main-content">
            <header class="header">
                <div class="header-left">
                    <button class="btn-menu" onclick="toggleSidebar()"><span class="menu-icon">‚ò∞</span></button>
                    <h1 class="header-title">Data Jamaah</h1>
                </div>
                <div class="header-right">
                    <div class="user-menu">
                        <div class="user-avatar" id="userAvatar">?</div>
                        <div class="user-info">
                            <div class="user-name" id="userName">Loading...</div>
                            <div class="user-role" id="userRole">-</div>
                        </div>
                    </div>
                    <button class="btn-logout-mobile" onclick="logout()">üö™</button>
                    <button class="btn btn-outline btn-sm" onclick="logout()">Keluar</button>
                </div>
            </header>
            
            <div class="page-content">
                <div class="page-header">
                    <div>
                        <div class="breadcrumb"><a href="dashboard.html">Dashboard</a><span>/</span><span>Pengaturan</span><span>/</span><span>Data Jamaah</span></div>
                        <h2 class="page-title">Data Jamaah (Admin)</h2>
                        <p class="text-muted">Kelola semua data jamaah termasuk yang sudah menikah</p>
                    </div>
                    <button class="btn btn-primary" id="btnTambah" onclick="showAddModal()" style="display:none;">‚ûï Tambah Jamaah</button>
                </div>
                
                <!-- Filters: Status ‚Üí Daerah ‚Üí Kelompok ‚Üí Jenjang -->
                <div class="card mb-lg">
                    <div class="card-body">
                        <div style="display:flex;flex-wrap:wrap;gap:1rem;align-items:flex-end;">
                            <div class="search-box">
                                <span class="search-icon">üîç</span>
                                <input type="text" class="form-control" id="searchInput" placeholder="Cari nama..." onkeyup="debounceSearch()">
                            </div>
                            <div>
                                <label class="form-label">Status</label>
                                <select class="form-control" id="filterStatus" onchange="loadJamaah()">
                                    <option value="aktif">Aktif</option>
                                    <option value="nonaktif">Nonaktif</option>
                                    <option value="lulus">Lulus</option>
                                    <option value="pindah">Pindah</option>
                                    <option value="menikah">Menikah</option>
                                    <option value="">Semua</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">Daerah</label>
                                <select class="form-control" id="filterDaerah" onchange="onFilterDaerahChange()">
                                    <option value="">Semua Daerah</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">Kelompok</label>
                                <select class="form-control" id="filterKelompok" onchange="loadJamaah()">
                                    <option value="">Semua Kelompok</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">Jenjang</label>
                                <select class="form-control" id="filterJenjang" onchange="loadJamaah()">
                                    <option value="">Semua Jenjang</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin-top:0.75rem;">
                            <small class="text-muted" id="infoTotal">Total: 0 santri</small>
                        </div>
                    </div>
                </div>
                
                <!-- Table -->
                <div class="card">
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table" id="santriTable">
                                <thead>
                                    <tr>
                                        <th>No</th>
                                        <th>Nama</th>
                                        <th>L/P</th>
                                        <th>Umur</th>
                                        <th>Jenjang</th>
                                        <th>Kelompok</th>
                                        <th>Status</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody><tr><td colspan="8" class="text-center text-muted py-4">Memuat data...</td></tr></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Modal Form Santri -->
    <div class="modal" id="santriModal">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h3 id="modalTitle">Tambah Santri</h3>
                <button class="modal-close" onclick="hideModal('santriModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="santriForm">
                    <input type="hidden" id="santriId" name="id">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label required">Nama Lengkap</label>
                            <input type="text" class="form-control" name="nama" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nama Panggilan</label>
                            <input type="text" class="form-control" name="nama_panggilan">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Tempat Lahir</label>
                            <input type="text" class="form-control" name="tempat_lahir">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tanggal Lahir</label>
                            <input type="date" class="form-control" name="tanggal_lahir" id="inputTanggalLahir" onchange="autoSelectJenjang()">
                            <small class="form-text" id="umurInfo"></small>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label required">Jenis Kelamin</label>
                            <select class="form-control" name="jenis_kelamin" required>
                                <option value="">-- Pilih --</option>
                                <option value="L">Laki-laki</option>
                                <option value="P">Perempuan</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">No. HP</label>
                            <input type="tel" class="form-control" name="phone">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Alamat</label>
                        <textarea class="form-control" name="alamat" rows="2"></textarea>
                    </div>
                    <hr style="margin:1.5rem 0;"><h4 style="margin-bottom:1rem;">Enrollment</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-control" name="status" id="formStatus" onchange="onStatusChange()">
                                <option value="aktif">Aktif</option>
                                <option value="nonaktif">Nonaktif</option>
                                <option value="lulus">Lulus</option>
                                <option value="pindah">Pindah</option>
                                <option value="menikah">Menikah</option>
                            </select>
                        </div>
                        <div class="form-group" id="pindahKeGroup" style="display:none;">
                            <label class="form-label">Pindah Ke</label>
                            <select class="form-control" id="pindahKe" onchange="onPindahKeChange()">
                                <option value="keluar">Keluar Sorong</option>
                                <option value="pindah_kelompok">Pindah Kelompok (dalam Sorong)</option>
                            </select>
                        </div>
                    </div>
                    <div id="enrollmentFields">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label required">Kelompok</label>
                                <select class="form-control" name="wilayah_id" id="formKelompok" required>
                                    <option value="">-- Pilih Kelompok --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label required">Jenjang</label>
                                <select class="form-control" name="jenjang_id" id="formJenjang" required>
                                    <option value="">-- Pilih --</option>
                                </select>
                                <small class="form-text" id="jenjangInfo">Akan otomatis dipilih berdasarkan umur</small>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" name="daerah_id" id="formDaerah">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('santriModal')">Batal</button>
                <button class="btn btn-primary" onclick="saveSantri()" id="btnSave">Simpan</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/sidebar.js"></script>
    
    <script>
        let editMode = false;
        let allWilayah = [];
        let allJenjang = [];
        let userWilayahId = null; // Wilayah dari role user
        const debounceSearch = debounce(() => loadJamaah(), 300);
        
        function toggleSidebar() {
            const sidebar = $('sidebar');
            const overlay = $('sidebarOverlay');
            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('show');
            } else {
                sidebar.classList.toggle('collapsed');
            }
            if (overlay) overlay.classList.toggle('show');
        }

        document.addEventListener('DOMContentLoaded', async () => {
            if (!await requireAuth()) return;
            updateSidebarUserInfo();
            initSidebar();
            updateUserUI();
            
            // Debug: tampilkan userRoles
            console.log('userRoles:', JSON.stringify(userRoles, null, 2));
            
            // Fallback: jika userRoles kosong, coba load ulang
            if (userRoles.length === 0 && currentUserData?.id) {
                console.log('userRoles kosong, mencoba load ulang...');
                const { data: rolesData, error } = await db
                    .from('user_role')
                    .select('*, role:role_id(kode, nama, level), wilayah:wilayah_id(id, nama, tingkat)')
                    .eq('user_id', currentUserData.id)
                    .eq('is_aktif', true);
                
                if (!error && rolesData) {
                    userRoles = rolesData;
                    console.log('userRoles reloaded:', JSON.stringify(userRoles, null, 2));
                } else {
                    console.error('Gagal reload userRoles:', error);
                }
            }
            
            // Cek apakah user adalah admin
            const isUserAdmin = userRoles.some(r => r.role?.kode?.toLowerCase() === 'admin');
            if (!isUserAdmin) {
                // Bukan admin, redirect ke halaman generus
                showToast('Halaman ini hanya untuk Admin. Silakan gunakan halaman Data Generus.', 'warning');
                setTimeout(() => {
                    window.location.href = 'generus.html';
                }, 2000);
                return;
            }
            
            // Get wilayah dari role user
            // Format dari query: { wilayah_id: 22, wilayah: { id: 22, nama: 'Klasaman', ... }, role: {...} }
            const userRoleWithWilayah = userRoles.find(r => r.wilayah_id || r.wilayah);
            if (userRoleWithWilayah) {
                // Ambil wilayah_id langsung atau dari nested object
                userWilayahId = userRoleWithWilayah.wilayah_id;
                console.log('User wilayah ID:', userWilayahId, 'Wilayah:', userRoleWithWilayah.wilayah);
            } else {
                console.log('User tidak punya wilayah, akan tampilkan semua data');
            }
            
            await loadFilters();
            await loadJamaah();
            
            // Tampilkan tombol tambah untuk admin
            $('btnTambah').style.display = 'block';
            
            if (getUrlParam('action') === 'add') showAddModal();
        });
        
        function updateUserUI() {
            if (currentUserData) {
                $('userName').textContent = currentUserData.nama || currentUserData.email;
                $('userAvatar').textContent = (currentUserData.nama || 'U').charAt(0).toUpperCase();
                if (userRoles.length > 0) $('userRole').textContent = userRoles[0].role?.nama || '-';
            }
        }
        
        async function loadFilters() {
            try {
                // Load semua wilayah
                const { data: wilayah } = await db.from('wilayah').select('*').eq('is_aktif', true).order('nama');
                allWilayah = wilayah || [];
                
                // Cek apakah admin
                const isAdmin = userRoles.some(r => r.role?.kode === 'admin');
                
                // Get wilayah user untuk menentukan filter yang ditampilkan
                const userWilayah = userWilayahId ? allWilayah.find(w => w.id === userWilayahId) : null;
                const userTingkat = userWilayah?.tingkat;
                
                // Populate filter daerah
                let daerahList = allWilayah.filter(w => w.tingkat === 'daerah');
                
                if (!isAdmin && userTingkat === 'daerah') {
                    // User level daerah: hanya tampilkan daerahnya
                    daerahList = daerahList.filter(d => d.id === userWilayahId);
                } else if (!isAdmin && userTingkat === 'desa') {
                    // User level desa: tampilkan parent daerahnya
                    daerahList = daerahList.filter(d => d.id === userWilayah.parent_id);
                } else if (!isAdmin && userTingkat === 'kelompok') {
                    // User level kelompok: cari parent desa lalu parent daerah
                    const desaUser = allWilayah.find(w => w.id === userWilayah.parent_id);
                    if (desaUser) {
                        daerahList = daerahList.filter(d => d.id === desaUser.parent_id);
                    }
                }
                
                $('filterDaerah').innerHTML = '<option value="">Semua Daerah</option>' + 
                    daerahList.map(d => `<option value="${d.id}">${d.nama}</option>`).join('');
                
                // Form daerah (hidden, auto-set ke daerah pertama)
                if (daerahList.length > 0) {
                    $('formDaerah').value = daerahList[0].id;
                }
                
                // Populate filter kelompok berdasarkan tingkat user
                let kelompokList = allWilayah.filter(w => w.tingkat === 'kelompok');
                
                if (!isAdmin && userTingkat === 'kelompok') {
                    kelompokList = kelompokList.filter(k => k.id === userWilayahId);
                } else if (!isAdmin && userTingkat === 'desa') {
                    kelompokList = kelompokList.filter(k => k.parent_id === userWilayahId);
                } else if (!isAdmin && userTingkat === 'daerah') {
                    // Get semua desa di daerah ini
                    const desaIds = allWilayah.filter(w => w.tingkat === 'desa' && w.parent_id === userWilayahId).map(d => d.id);
                    kelompokList = kelompokList.filter(k => desaIds.includes(k.parent_id));
                }
                
                $('filterKelompok').innerHTML = '<option value="">Semua Kelompok</option>' + 
                    kelompokList.map(k => `<option value="${k.id}">${k.nama}</option>`).join('');
                
                // Form kelompok (untuk tambah/edit santri)
                $('formKelompok').innerHTML = '<option value="">-- Pilih Kelompok --</option>' + 
                    kelompokList.map(k => `<option value="${k.id}">${k.nama}</option>`).join('');
                
                // Auto-select jika hanya 1 kelompok
                if (kelompokList.length === 1) {
                    $('filterKelompok').value = kelompokList[0].id;
                    $('formKelompok').value = kelompokList[0].id;
                }
                
                // Load jenjang
                const { data: jenjang } = await db.from('jenjang').select('*').eq('is_aktif', true).order('urutan');
                allJenjang = jenjang || [];
                
                $('filterJenjang').innerHTML = '<option value="">Semua Jenjang</option>' + 
                    allJenjang.map(j => `<option value="${j.id}">${j.nama}</option>`).join('');
                
                $('formJenjang').innerHTML = '<option value="">-- Pilih --</option>' + 
                    allJenjang.map(j => {
                        const usiaText = (j.usia_mulai && j.usia_sampai) ? ` (${j.usia_mulai}-${j.usia_sampai} th)` : '';
                        return `<option value="${j.id}">${j.nama}${usiaText}</option>`;
                    }).join('');
                    
            } catch (error) {
                console.error('Error loading filters:', error);
            }
        }
        
        // Filter daerah berubah -> update kelompok
        function onFilterDaerahChange() {
            const daerahId = $('filterDaerah').value;
            
            let kelompokList;
            if (daerahId) {
                // Get kelompok dalam daerah ini (langsung dari parent_id karena struktur 2 level)
                kelompokList = allWilayah.filter(w => w.tingkat === 'kelompok' && w.parent_id == daerahId);
            } else {
                kelompokList = allWilayah.filter(w => w.tingkat === 'kelompok');
            }
            
            $('filterKelompok').innerHTML = '<option value="">Semua Kelompok</option>' + 
                kelompokList.map(k => `<option value="${k.id}">${k.nama}</option>`).join('');
            
            loadJamaah();
        }
        
        // Form daerah berubah -> update kelompok di form (tidak dipakai lagi, daerah di-hidden)
        function onFormDaerahChange() {
            // Langsung load semua kelompok karena hanya 1 daerah
            loadKelompokOptions();
        }
        
        // Load kelompok options
        function loadKelompokOptions() {
            const kelompokList = allWilayah.filter(w => w.tingkat === 'kelompok');
            $('formKelompok').innerHTML = '<option value="">-- Pilih Kelompok --</option>' + 
                kelompokList.map(k => `<option value="${k.id}">${k.nama}</option>`).join('');
        }
        
        // Handler saat status berubah
        function onStatusChange() {
            const status = $('formStatus').value;
            const pindahKeGroup = $('pindahKeGroup');
            const enrollmentFields = $('enrollmentFields');
            const formKelompok = $('formKelompok');
            const formJenjang = $('formJenjang');
            
            if (status === 'pindah') {
                // Tampilkan pilihan pindah ke mana
                pindahKeGroup.style.display = 'block';
                onPindahKeChange(); // Update enrollment fields
            } else if (status === 'menikah' || status === 'lulus') {
                // Menikah/Lulus: tidak perlu enrollment baru
                pindahKeGroup.style.display = 'none';
                enrollmentFields.style.display = 'none';
                formKelompok.removeAttribute('required');
                formJenjang.removeAttribute('required');
            } else {
                // Aktif/Nonaktif: perlu enrollment
                pindahKeGroup.style.display = 'none';
                enrollmentFields.style.display = 'block';
                formKelompok.setAttribute('required', 'required');
                formJenjang.setAttribute('required', 'required');
            }
        }
        
        // Handler saat pilihan pindah berubah
        function onPindahKeChange() {
            const pindahKe = $('pindahKe').value;
            const enrollmentFields = $('enrollmentFields');
            const formKelompok = $('formKelompok');
            const formJenjang = $('formJenjang');
            
            if (pindahKe === 'keluar') {
                // Pindah keluar: tidak perlu enrollment
                enrollmentFields.style.display = 'none';
                formKelompok.removeAttribute('required');
                formJenjang.removeAttribute('required');
            } else {
                // Pindah kelompok: perlu pilih kelompok baru
                enrollmentFields.style.display = 'block';
                formKelompok.setAttribute('required', 'required');
                formJenjang.setAttribute('required', 'required');
            }
        }
        
        // Auto select jenjang berdasarkan umur
        function autoSelectJenjang() {
            const tanggalLahir = $('inputTanggalLahir').value;
            const umurInfo = $('umurInfo');
            const jenjangInfo = $('jenjangInfo');
            const selectJenjang = $('formJenjang');
            
            if (!tanggalLahir) {
                umurInfo.textContent = '';
                jenjangInfo.textContent = 'Akan otomatis dipilih berdasarkan umur';
                return;
            }
            
            const umur = hitungUmur(tanggalLahir);
            umurInfo.innerHTML = `<strong>Umur: ${umur} tahun</strong>`;
            
            let matchedJenjang = null;
            
            // Umur 18+ otomatis Pra Nikah (sebelum menikah)
            if (umur >= 18) {
                matchedJenjang = allJenjang.find(j => j.nama.toLowerCase().includes('pra nikah') || j.nama.toLowerCase().includes('pranikah'));
            }
            
            // Jika tidak ketemu Pra Nikah atau umur < 18, cari berdasarkan range
            if (!matchedJenjang) {
                for (const j of allJenjang) {
                    const usiaMin = j.usia_mulai || 0;
                    const usiaMax = j.usia_sampai || 99;
                    if (umur >= usiaMin && umur <= usiaMax) {
                        matchedJenjang = j;
                        break;
                    }
                }
            }
            
            if (matchedJenjang) {
                selectJenjang.value = matchedJenjang.id;
                jenjangInfo.innerHTML = `<span class="text-success">‚úì Otomatis: ${matchedJenjang.nama}</span>`;
            } else {
                jenjangInfo.innerHTML = `<span class="text-warning">‚ö† Tidak ada jenjang untuk umur ${umur} tahun. Pilih manual.</span>`;
            }
        }
        
        async function loadJamaah() {
            try {
                const search = $('searchInput').value.trim().toLowerCase();
                const status = $('filterStatus').value || 'aktif';
                const daerahId = $('filterDaerah').value;
                const kelompokId = $('filterKelompok').value;
                const jenjangId = $('filterJenjang').value;
                
                // Tentukan wilayah_id untuk query
                let wilayahId = null;
                
                if (kelompokId) {
                    wilayahId = parseInt(kelompokId);
                } else if (daerahId) {
                    wilayahId = parseInt(daerahId);
                } else if (userWilayahId) {
                    wilayahId = userWilayahId;
                }
                
                console.log('Loading jamaah with params:', { wilayahId, jenjangId, status });
                
                // Panggil RPC function
                const { data, error } = await db.rpc('get_jamaah_by_wilayah', {
                    p_wilayah_id: wilayahId,
                    p_jenjang_id: jenjangId ? parseInt(jenjangId) : null,
                    p_status: status || null
                });
                
                console.log('RPC result:', { data, error });
                
                if (error) throw error;
                
                // Filter by search (client-side)
                let filtered = data || [];
                if (search) {
                    filtered = filtered.filter(s => 
                        s.nama.toLowerCase().includes(search) ||
                        (s.nama_panggilan && s.nama_panggilan.toLowerCase().includes(search))
                    );
                }
                
                $('infoTotal').textContent = `Total: ${filtered.length} jamaah`;
                renderTable(filtered);
                
            } catch (error) {
                console.error('Error loading jamaah:', error);
                showToast('Gagal memuat data jamaah: ' + (error.message || error), 'error');
            }
        }
        
        function renderTable(data) {
            const tbody = $$('#santriTable tbody');
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">Tidak ada data</td></tr>';
                return;
            }
            
            // FORCE ENABLE CRUD - Halaman ini di menu Pengaturan, 
            // hanya admin/mubaligh yang seharusnya bisa akses
            // Jadi kita tampilkan tombol edit untuk semua yang bisa akses halaman ini
            const canEdit = true;  // Force enable
            const canDelete = true; // Force enable untuk admin
            
            // Debug
            console.log('renderTable - FORCE CRUD ENABLED');
            
            tbody.innerHTML = data.map((s, i) => {
                // Data dari RPC sudah flat, bukan nested
                const statusBadge = getStatusBadge(s.status);
                
                // Action buttons - always show edit & delete
                const actionButtons = `
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline" onclick="editJamaah(${s.jamaah_id})" title="Edit">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteJamaah(${s.jamaah_id})" title="Hapus">üóëÔ∏è</button>
                    </div>`;
                
                return `
                <tr>
                    <td>${i + 1}</td>
                    <td>
                        <strong>${s.nama}</strong>
                        ${s.nama_panggilan ? `<br><small class="text-muted">${s.nama_panggilan}</small>` : ''}
                    </td>
                    <td>${s.jenis_kelamin || '-'}</td>
                    <td>${s.tanggal_lahir ? hitungUmur(s.tanggal_lahir) + ' th' : '-'}</td>
                    <td><span class="badge badge-info">${s.jenjang_nama || '-'}</span></td>
                    <td>${s.kelompok_nama || '-'}</td>
                    <td>${statusBadge}</td>
                    <td>${actionButtons}</td>
                </tr>`;
            }).join('');
        }
        
        function getStatusBadge(status) {
            const badges = {
                'aktif': '<span class="badge badge-success">Aktif</span>',
                'nonaktif': '<span class="badge badge-secondary">Nonaktif</span>',
                'lulus': '<span class="badge badge-primary">Lulus</span>',
                'pindah': '<span class="badge badge-warning">Pindah</span>',
                'menikah': '<span class="badge badge-info">Menikah</span>'
            };
            return badges[status] || `<span class="badge badge-secondary">${status || '-'}</span>`;
        }
        
        function viewJamaah(id) {
            showToast('Anda hanya bisa melihat data. Hubungi admin/mubaligh untuk edit.', 'info');
        }
        
        function showAddModal() {
            editMode = false;
            $('modalTitle').textContent = 'Tambah Jamaah';
            $('santriForm').reset();
            $('santriId').value = '';
            $('umurInfo').textContent = '';
            $('jenjangInfo').textContent = 'Akan otomatis dipilih berdasarkan umur';
            $('formStatus').value = 'aktif';
            $('pindahKeGroup').style.display = 'none';
            $('enrollmentFields').style.display = 'block';
            
            // Reset required attributes
            $('formKelompok').setAttribute('required', 'required');
            $('formJenjang').setAttribute('required', 'required');
            
            showModal('santriModal');
        }
        
        async function editJamaah(id) {
            try {
                // Get jamaah with enrollment
                const { data: jamaah, error } = await db.from('jamaah').select('*').eq('id', id).single();
                if (error) throw error;
                
                // Get active enrollment
                const { data: enrollment } = await db.from('enrollment')
                    .select('*, wilayah:wilayah_id(*), jenjang:jenjang_id(*)')
                    .eq('jamaah_id', id)
                    .eq('status', 'aktif')
                    .single();
                
                editMode = true;
                $('modalTitle').textContent = 'Edit Jamaah';
                $('santriId').value = jamaah.id;
                
                const form = $('santriForm');
                form.querySelector('[name="nama"]').value = jamaah.nama || '';
                form.querySelector('[name="nama_panggilan"]').value = jamaah.nama_panggilan || '';
                form.querySelector('[name="tempat_lahir"]').value = jamaah.tempat_lahir || '';
                form.querySelector('[name="tanggal_lahir"]').value = jamaah.tanggal_lahir || '';
                form.querySelector('[name="jenis_kelamin"]').value = jamaah.jenis_kelamin || '';
                form.querySelector('[name="phone"]').value = jamaah.phone || '';
                form.querySelector('[name="alamat"]').value = jamaah.alamat_lengkap || '';
                $('formStatus').value = jamaah.status_aktif || 'aktif';
                
                // Set enrollment data
                if (enrollment && enrollment.wilayah) {
                    $('formKelompok').value = enrollment.wilayah_id;
                    $('formJenjang').value = enrollment.jenjang_id || '';
                }
                
                // Handle status display
                onStatusChange();
                
                if (jamaah.tanggal_lahir) {
                    const umur = hitungUmur(jamaah.tanggal_lahir);
                    $('umurInfo').innerHTML = `<strong>Umur: ${umur} tahun</strong>`;
                } else {
                    $('umurInfo').textContent = '';
                    $('jenjangInfo').textContent = '';
                }
                
                showModal('santriModal');
            } catch (error) {
                console.error('Error:', error);
                showToast('Gagal memuat data', 'error');
            }
        }
        
        async function saveJamaah() {
            const form = $('santriForm');
            const status = $('formStatus').value;
            const pindahKe = $('pindahKe')?.value;
            
            // Validasi form - skip enrollment validation jika pindah keluar/menikah/lulus
            const skipEnrollment = (status === 'pindah' && pindahKe === 'keluar') || 
                                   status === 'menikah' || 
                                   status === 'lulus';
            
            if (!skipEnrollment && !form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const btn = $('btnSave');
            btn.disabled = true;
            btn.textContent = 'Menyimpan...';
            
            try {
                const formData = getFormData('santriForm');
                const jamaahData = {
                    nama: formData.nama,
                    nama_panggilan: formData.nama_panggilan,
                    tempat_lahir: formData.tempat_lahir,
                    tanggal_lahir: formData.tanggal_lahir || null,
                    jenis_kelamin: formData.jenis_kelamin,
                    phone: formData.phone,
                    alamat_lengkap: formData.alamat,
                    status_aktif: formData.status || 'aktif'
                };
                
                let jamaahId = formData.id;
                
                if (editMode && jamaahId) {
                    // Update jamaah
                    const { error } = await db.from('jamaah').update(jamaahData).eq('id', jamaahId);
                    if (error) throw error;
                    
                    // Handle enrollment berdasarkan status
                    if (status === 'pindah' && pindahKe === 'keluar') {
                        // Pindah keluar: nonaktifkan enrollment lama
                        await db.from('enrollment').update({
                            status: 'nonaktif'
                        }).eq('jamaah_id', jamaahId).eq('status', 'aktif');
                        
                    } else if (status === 'menikah' || status === 'lulus') {
                        // Menikah/Lulus: nonaktifkan enrollment
                        await db.from('enrollment').update({
                            status: 'nonaktif'
                        }).eq('jamaah_id', jamaahId).eq('status', 'aktif');
                        
                    } else if (status === 'pindah' && pindahKe === 'pindah_kelompok') {
                        // Pindah kelompok: nonaktifkan enrollment lama, buat baru
                        await db.from('enrollment').update({
                            status: 'nonaktif'
                        }).eq('jamaah_id', jamaahId).eq('status', 'aktif');
                        
                        const { data: ta } = await db.from('tahun_ajaran').select('id').eq('is_aktif', true).single();
                        await db.from('enrollment').insert({
                            jamaah_id: jamaahId,
                            wilayah_id: formData.wilayah_id,
                            jenjang_id: formData.jenjang_id,
                            tahun_ajaran_id: ta?.id,
                            status: 'aktif',
                            created_by: currentUserData?.id
                        });
                        
                        // Set jamaah status kembali aktif
                        await db.from('jamaah').update({ status_aktif: 'aktif' }).eq('id', jamaahId);
                        
                    } else {
                        // Update enrollment biasa
                        await db.from('enrollment').update({
                            wilayah_id: formData.wilayah_id,
                            jenjang_id: formData.jenjang_id
                        }).eq('jamaah_id', jamaahId).eq('status', 'aktif');
                    }
                    
                } else {
                    // Insert jamaah baru
                    jamaahData.created_by = currentUserData?.id;
                    const { data: newJamaah, error } = await db.from('jamaah').insert(jamaahData).select().single();
                    if (error) throw error;
                    
                    jamaahId = newJamaah.id;
                    
                    // Get active tahun ajaran
                    const { data: ta } = await db.from('tahun_ajaran').select('id').eq('is_aktif', true).single();
                    
                    // Insert enrollment
                    await db.from('enrollment').insert({
                        jamaah_id: jamaahId,
                        wilayah_id: formData.wilayah_id,
                        jenjang_id: formData.jenjang_id,
                        tahun_ajaran_id: ta?.id,
                        status: 'aktif',
                        created_by: currentUserData?.id
                    });
                }
                
                showToast('Data jamaah berhasil disimpan', 'success');
                hideModal('santriModal');
                loadJamaah();
                
            } catch (error) {
                console.error('Error:', error);
                showToast('Gagal menyimpan data: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Simpan';
            }
        }
        
        async function deleteJamaah(id) {
            // Cek apakah user adalah admin
            const isAdmin = userRoles.some(r => r.role?.kode === 'admin');
            if (!isAdmin) {
                showToast('Hanya Admin yang dapat menghapus data jamaah', 'error');
                return;
            }
            
            if (!await confirmDialog('Yakin ingin menghapus jamaah ini? Data yang dihapus tidak dapat dikembalikan.')) return;
            
            try {
                // Delete enrollment first
                await db.from('enrollment').delete().eq('jamaah_id', id);
                // Delete jamaah
                const { error } = await db.from('jamaah').delete().eq('id', id);
                if (error) throw error;
                
                showToast('Jamaah berhasil dihapus', 'success');
                loadJamaah();
            } catch (error) {
                console.error('Error:', error);
                showToast('Gagal menghapus: ' + error.message, 'error');
            }
        }
    </script>


    <!-- Bottom Navigation for Mobile -->
    <nav class="bottom-nav">
        <div class="bottom-nav-grid">
            <a href="dashboard.html" class="bottom-nav-item">
                <span class="bottom-nav-icon">üìä</span>
                <span class="bottom-nav-label">Home</span>
            </a>
            <a href="generus.html" class="bottom-nav-item">
                <span class="bottom-nav-icon">üë∂</span>
                <span class="bottom-nav-label">Generus</span>
            </a>
            <a href="presensi.html" class="bottom-nav-item">
                <span class="bottom-nav-icon">‚úÖ</span>
                <span class="bottom-nav-label">Presensi</span>
            </a>
            <a href="progress.html" class="bottom-nav-item">
                <span class="bottom-nav-icon">üìà</span>
                <span class="bottom-nav-label">Progress</span>
            </a>
            <a href="#" class="bottom-nav-item" onclick="toggleSidebar(); return false;">
                <span class="bottom-nav-icon">‚ò∞</span>
                <span class="bottom-nav-label">Menu</span>
            </a>
        </div>
    </nav>
</body>
</html>