<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#059669">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="images/icon-192x192.svg">
    <link rel="icon" type="image/svg+xml" href="images/icon-72x72.svg">
    <title>Pengajian - PPG Sorong</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .badge-mingguan { background: #dcfce7; color: #166534; }
        .badge-bulanan { background: #fef3c7; color: #92400e; }
        .badge-3bulanan { background: #f3e8ff; color: #7c3aed; }
        .tab-container { border-bottom: 1px solid var(--gray-200); margin-bottom: 1.5rem; }
        .tab-nav { display: flex; gap: 0; }
        .tab-btn { padding: 0.75rem 1.5rem; border: none; background: none; cursor: pointer; font-weight: 500; color: var(--gray-600); border-bottom: 2px solid transparent; transition: all 0.2s; }
        .tab-btn:hover { color: var(--primary); }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .jadwal-card { background: white; border: 1px solid var(--gray-200); border-radius: var(--radius-md); padding: 1rem; margin-bottom: 0.75rem; }
        .jadwal-card:hover { border-color: var(--primary); }
        .jadwal-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
        .jadwal-title { font-weight: 600; color: var(--gray-900); }
        .jadwal-info { font-size: 0.875rem; color: var(--gray-600); }
        .jadwal-actions { display: flex; gap: 0.5rem; }
    </style>
</head>
<body>
    <div class="app-container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">PPG</div>
                <div class="sidebar-brand">
                    <div class="sidebar-title">PPG Sorong</div>
                    <div class="sidebar-subtitle">Pembinaan Generasi Penerus</div>
                </div>
                <button class="sidebar-close" onclick="toggleSidebar()">‚úï</button>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">MENU UTAMA</div>
                <a href="dashboard.html" class="nav-item"><span class="nav-icon">üìä</span><span class="nav-text">Dashboard</span></a>
                <a href="jamaah.html" class="nav-item"><span class="nav-icon">üë•</span><span class="nav-text">Data Jamaah</span></a>
                <a href="pengajian.html" class="nav-item active"><span class="nav-icon">üìñ</span><span class="nav-text">Pengajian</span></a>
                <a href="presensi.html" class="nav-item"><span class="nav-icon">‚úÖ</span><span class="nav-text">Presensi</span></a>
                <a href="progress.html" class="nav-item"><span class="nav-icon">üìà</span><span class="nav-text">Progress Hafalan</span></a>
                <div class="nav-section">LAPORAN</div>
                <a href="rapor.html" class="nav-item"><span class="nav-icon">üìã</span><span class="nav-text">Rapor</span></a>
                <div class="nav-section">PENGATURAN</div>
                <a href="wilayah.html" class="nav-item"><span class="nav-icon">üó∫Ô∏è</span><span class="nav-text">Wilayah</span></a>
                <a href="kurikulum.html" class="nav-item"><span class="nav-icon">üìö</span><span class="nav-text">Kurikulum</span></a>
                <a href="users.html" class="nav-item"><span class="nav-icon">üë§</span><span class="nav-text">Manajemen User</span></a>
            </nav>
            <div class="sidebar-footer">
                <div class="sidebar-user">
                    <div class="sidebar-user-avatar" id="sidebarUserAvatar">?</div>
                    <div class="sidebar-user-info">
                        <div class="sidebar-user-name" id="sidebarUserName">Loading...</div>
                        <div class="sidebar-user-role" id="sidebarUserRole">-</div>
                    </div>
                </div>
                <button class="btn btn-sm btn-outline w-100" onclick="logout()">üö™ Keluar</button>
            </div>
        </aside>
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
        
        <main class="main-content">
            <header class="header">
                <div class="header-left">
                    <button class="btn-menu" onclick="toggleSidebar()"><span class="menu-icon">‚ò∞</span></button>
                    <h1 class="header-title">Pengajian</h1>
                </div>
                <div class="header-right">
                    <div class="header-user">
                        <div class="user-avatar" id="userAvatar">?</div>
                        <div class="user-info">
                            <div class="user-name" id="userName">Loading...</div>
                            <div class="user-role" id="userRole">-</div>
                        </div>
                    </div>
                </div>
            </header>
            
            <div class="page-content">
                <div class="page-header">
                    <div>
                        <div class="breadcrumb"><a href="dashboard.html">Dashboard</a><span>/</span><span>Pengajian</span></div>
                        <h2 class="page-title">Kelola Pengajian</h2>
                    </div>
                    <button class="btn btn-primary" onclick="showAddModal()">‚ûï Buat Pengajian</button>
                </div>
                
                <!-- Stats -->
                <div class="stats-grid mb-lg">
                    <div class="stat-card">
                        <div class="stat-icon primary">üìÖ</div>
                        <div class="stat-content"><div class="stat-value" id="totalJadwal">0</div><div class="stat-label">Jadwal Aktif</div></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon success">üìñ</div>
                        <div class="stat-content"><div class="stat-value" id="totalPengajian">0</div><div class="stat-label">Pengajian Bulan Ini</div></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon warning">‚úÖ</div>
                        <div class="stat-content"><div class="stat-value" id="pengajianSelesai">0</div><div class="stat-label">Sudah Presensi</div></div>
                    </div>
                </div>
                
                <!-- Filters -->
                <div class="card mb-lg">
                    <div class="card-body">
                        <div style="display:flex;flex-wrap:wrap;gap:1rem;align-items:flex-end;">
                            <div>
                                <label class="form-label">Bulan</label>
                                <input type="month" class="form-control" id="filterBulan" onchange="loadPengajian()">
                            </div>
                            <div>
                                <label class="form-label">Jenjang</label>
                                <select class="form-control" id="filterJenjang" onchange="loadPengajian()">
                                    <option value="">Semua Jenjang</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">Wilayah</label>
                                <select class="form-control" id="filterWilayah" onchange="loadPengajian()">
                                    <option value="">Semua Wilayah</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Table -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Daftar Pengajian</h3>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table" id="pengajianTable">
                                <thead>
                                    <tr>
                                        <th>No</th>
                                        <th>Tanggal</th>
                                        <th>Jenjang</th>
                                        <th>Wilayah</th>
                                        <th>Waktu</th>
                                        <th>Materi</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody><tr><td colspan="7" class="text-center text-muted py-4">Memuat data...</td></tr></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Modal Form -->
    <div class="modal" id="pengajianModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Buat Pengajian</h3>
                <button class="modal-close" onclick="hideModal('pengajianModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="pengajianForm">
                    <input type="hidden" name="id" id="pengajianId">
                    <div class="form-group">
                        <label class="form-label required">Jenjang</label>
                        <select class="form-control" name="jenjang_id" id="selectJenjangForm" required>
                            <option value="">-- Pilih Jenjang --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Wilayah</label>
                        <select class="form-control" name="wilayah_id" id="selectWilayahForm" required>
                            <option value="">-- Pilih Wilayah --</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label required">Tanggal</label>
                            <input type="date" class="form-control" name="tanggal" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Waktu Mulai</label>
                            <input type="time" class="form-control" name="waktu_mulai">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Waktu Selesai</label>
                            <input type="time" class="form-control" name="waktu_selesai">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Materi</label>
                        <textarea class="form-control" name="materi" rows="3" placeholder="Materi yang akan diajarkan..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('pengajianModal')">Batal</button>
                <button class="btn btn-primary" id="btnSave" onclick="savePengajian()">Simpan</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/sidebar.js"></script>
    
    <script>
        let editMode = false;
        
        function toggleSidebar() {
            $('sidebar').classList.toggle('collapsed');
            $('sidebarOverlay').classList.toggle('show');
        }

        document.addEventListener('DOMContentLoaded', async () => {
            if (!await requireAuth()) return;
            updateSidebarUserInfo();
            initSidebar();
            updateUserUI();
            
            // Set default month to current
            const now = new Date();
            $('filterBulan').value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            
            await loadFilters();
            await loadStats();
            await loadPengajian();
        });
        
        function updateUserUI() {
            if (currentUserData) {
                $('userName').textContent = currentUserData.nama || currentUserData.email;
                $('userAvatar').textContent = (currentUserData.nama || 'U').charAt(0).toUpperCase();
                if (userRoles.length > 0) $('userRole').textContent = userRoles[0].role?.nama || '-';
            }
        }
        
        async function loadStats() {
            try {
                // Jadwal aktif
                const { count: jadwalCount } = await db.from('jadwal_pengajian')
                    .select('*', { count: 'exact', head: true })
                    .eq('is_aktif', true);
                $('totalJadwal').textContent = jadwalCount || 0;
                
                // Pengajian bulan ini
                const startOfMonth = new Date();
                startOfMonth.setDate(1);
                const { count: pengajianCount } = await db.from('pengajian')
                    .select('*', { count: 'exact', head: true })
                    .gte('tanggal', startOfMonth.toISOString().split('T')[0]);
                $('totalPengajian').textContent = pengajianCount || 0;
                
                // Pengajian yang sudah ada presensi
                const { data: pengajianWithPresensi } = await db.from('pengajian')
                    .select('id, keaktifan_pengajian(id)')
                    .gte('tanggal', startOfMonth.toISOString().split('T')[0]);
                
                const selesaiCount = pengajianWithPresensi?.filter(p => p.keaktifan_pengajian?.length > 0).length || 0;
                $('pengajianSelesai').textContent = selesaiCount;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }
        
        async function loadFilters() {
            try {
                // Load jenjang
                const { data: jenjang } = await db.from('jenjang')
                    .select('id, nama')
                    .eq('is_aktif', true)
                    .order('urutan');
                
                if (jenjang) {
                    const jenjangOptions = jenjang.map(j => `<option value="${j.id}">${j.nama}</option>`).join('');
                    $('filterJenjang').innerHTML += jenjangOptions;
                    $('selectJenjangForm').innerHTML += jenjangOptions;
                }
                
                // Load wilayah (kelompok)
                const { data: wilayah } = await db.from('wilayah')
                    .select('id, nama, tingkat')
                    .eq('is_aktif', true)
                    .order('nama');
                
                if (wilayah) {
                    const wilayahOptions = wilayah.map(w => `<option value="${w.id}">${w.nama} (${w.tingkat})</option>`).join('');
                    $('filterWilayah').innerHTML += wilayahOptions;
                    $('selectWilayahForm').innerHTML += wilayahOptions;
                }
            } catch (error) {
                console.error('Error loading filters:', error);
            }
        }
        
        async function loadPengajian() {
            try {
                const bulan = $('filterBulan').value;
                const jenjangId = $('filterJenjang').value;
                const wilayahId = $('filterWilayah').value;
                
                let query = db.from('pengajian')
                    .select(`
                        *,
                        wilayah:wilayah_id(nama),
                        jenjang:jenjang_id(nama),
                        creator:created_by(nama)
                    `)
                    .order('tanggal', { ascending: false });
                
                if (bulan) {
                    const [year, month] = bulan.split('-');
                    const start = `${year}-${month}-01`;
                    const lastDay = new Date(year, month, 0).getDate();
                    const end = `${year}-${month}-${lastDay}`;
                    query = query.gte('tanggal', start).lte('tanggal', end);
                }
                
                if (jenjangId) query = query.eq('jenjang_id', jenjangId);
                if (wilayahId) query = query.eq('wilayah_id', wilayahId);
                
                const { data, error } = await query;
                if (error) throw error;
                
                renderTable(data || []);
            } catch (error) {
                console.error('Error:', error);
                showToast('Gagal memuat data', 'error');
            }
        }
        
        function renderTable(data) {
            const tbody = $$('#pengajianTable tbody');
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">Tidak ada data pengajian</td></tr>';
                return;
            }
            
            tbody.innerHTML = data.map((p, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td>
                        <strong>${formatTanggal(p.tanggal)}</strong>
                    </td>
                    <td>
                        <span class="badge badge-primary">${p.jenjang?.nama || '-'}</span>
                    </td>
                    <td>${p.wilayah?.nama || '-'}</td>
                    <td>
                        ${p.waktu_mulai ? formatWaktu(p.waktu_mulai) : '-'}
                        ${p.waktu_selesai ? ' - ' + formatWaktu(p.waktu_selesai) : ''}
                    </td>
                    <td>${p.materi || '-'}</td>
                    <td>
                        <div class="btn-group">
                            <a href="presensi.html?pengajian_id=${p.id}" class="btn btn-sm btn-success" title="Input Presensi">‚úÖ</a>
                            <button class="btn btn-sm btn-outline" onclick="editPengajian(${p.id})" title="Edit">‚úèÔ∏è</button>
                            <button class="btn btn-sm btn-danger" onclick="deletePengajian(${p.id})" title="Hapus">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        function showAddModal() {
            editMode = false;
            $('modalTitle').textContent = 'Buat Pengajian';
            $('pengajianForm').reset();
            $('pengajianId').value = '';
            // Set default date to today
            $('pengajianForm').querySelector('[name="tanggal"]').value = new Date().toISOString().split('T')[0];
            showModal('pengajianModal');
        }
        
        async function editPengajian(id) {
            try {
                const { data, error } = await db.from('pengajian').select('*').eq('id', id).single();
                if (error) throw error;
                
                editMode = true;
                $('modalTitle').textContent = 'Edit Pengajian';
                $('pengajianId').value = data.id;
                setFormData('pengajianForm', data);
                showModal('pengajianModal');
            } catch (error) {
                showToast('Gagal memuat data', 'error');
            }
        }
        
        async function savePengajian() {
            const form = $('pengajianForm');
            if (!form.checkValidity()) { form.reportValidity(); return; }
            
            const btn = $('btnSave');
            btn.disabled = true;
            btn.textContent = 'Menyimpan...';
            
            try {
                const formData = getFormData('pengajianForm');
                const pengajianData = {
                    jenjang_id: parseInt(formData.jenjang_id),
                    wilayah_id: parseInt(formData.wilayah_id),
                    tanggal: formData.tanggal,
                    waktu_mulai: formData.waktu_mulai || null,
                    waktu_selesai: formData.waktu_selesai || null,
                    materi: formData.materi || null
                };
                
                if (editMode && formData.id) {
                    const { error } = await db.from('pengajian').update(pengajianData).eq('id', formData.id);
                    if (error) throw error;
                } else {
                    pengajianData.created_by = currentUserData?.id;
                    const { error } = await db.from('pengajian').insert(pengajianData);
                    if (error) throw error;
                }
                
                showToast('Pengajian berhasil disimpan', 'success');
                hideModal('pengajianModal');
                await loadStats();
                await loadPengajian();
            } catch (error) {
                console.error('Error:', error);
                showToast('Gagal menyimpan: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Simpan';
            }
        }
        
        async function deletePengajian(id) {
            if (!await confirmDialog('Yakin ingin menghapus pengajian ini? Data presensi juga akan ikut terhapus.')) return;
            
            try {
                // Delete related keaktifan first
                await db.from('keaktifan_pengajian').delete().eq('pengajian_id', id);
                
                // Then delete pengajian
                const { error } = await db.from('pengajian').delete().eq('id', id);
                if (error) throw error;
                
                showToast('Pengajian berhasil dihapus', 'success');
                await loadStats();
                await loadPengajian();
            } catch (error) {
                console.error('Error:', error);
                showToast('Gagal menghapus: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>
